<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Solstr√•le</title>
	<style type="text/css">
		body {
			margin: 0;
			overflow: hidden;
		}
	</style>
</head>

<body>
	<div>
		samplesPerPixel: <input id="samplesPerPixel" type="number" min="1" value="100"/>
		<button onClick="run();" id="runButton" disabled>Run</button>
		progress: <span id="progress"></span>
	</div>
	<canvas id="canvas"></canvas>

	<script>

		let canvas = document.getElementById('canvas');
		let ctx = canvas.getContext('2d');
		let startTime;
		let traceWorker = new Worker('multiTraceWorker.js');

		
		let image = new Image()
		image.onload = function() {

			let offscreen = new OffscreenCanvas(image.width, image.height)
			offscrenCtx = offscreen.getContext('2d')
			offscrenCtx.drawImage(image, 0, 0)
			imageData = offscrenCtx.getImageData(0, 0, image.width, image.height)

			traceWorker.postMessage({
				type: "init",
				availableConcurrency: window.navigator.hardwareConcurrency,
				texture: {
					name: "earth",
					width: image.width,
					height: image.height,
					data: imageData.data,
				}
			})
		}
		image.src = "earthmap.jpg"

		traceWorker.onerror = function(event) {
			console.log('There is an error in trace worker: ' + event);
		}
		traceWorker.onmessage = function(e) {
			if (e.data.type === "init") {
				document.getElementById("runButton").disabled = false;

			} else if (e.data.type === "image") {

				let spec = e.data.specification

				let imageArray = new Uint8ClampedArray(e.data.buffer)
				let imageData = new ImageData(imageArray, spec.drawWidth, spec.drawHeight);
				ctx.putImageData(imageData, spec.drawOffsetX, spec.drawOffsetY);

				let p = document.getElementById("progress");
				let percent = (e.data.progress * 100).toFixed(1)
				p.innerText = percent + "%"

				if (percent === "100.0") {
					let duration = ((performance.now() - startTime) / 1000).toFixed(2)
					p.innerText += ', took ' + duration + 's'
				}

			}
		}

		function run() {

			let samplesPerPixel = document.getElementById("samplesPerPixel").value;
			let width = window.innerWidth;
			let height = window.innerHeight - canvas.getBoundingClientRect().top;			
			canvas.width = width;
			canvas.height = height;

			document.getElementById("runButton").disabled = true;
			
			traceWorker.postMessage({
				type: "start",
				specification: {
					width: width,
					height: height,
					samplesPerPixel: parseInt(samplesPerPixel)
				},
			})
			startTime = performance.now()	
		}
	</script>

</body>

</html>