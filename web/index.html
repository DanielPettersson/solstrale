<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Solstr√•le</title>
	<style type="text/css">
		body {
			margin: 0;
			overflow: hidden;
		}
	</style>
</head>

<body>
	<div>
		<button onClick="run();" id="runButton" disabled>Run</button>
		progress: <span id="progress"></span>
	</div>
	<canvas id="canvas"></canvas>

	<script>

		let canvas = document.getElementById('canvas');
		const width = window.innerWidth;
		const height = window.innerHeight - canvas.getBoundingClientRect().top;
		let ctx = canvas.getContext('2d');
		canvas.width = width;
		canvas.height = height;

		let startTime;

		
		let traceWorker = new Worker('multiTraceWorker.js');
		traceWorker.postMessage({
			type: "init",
			specification: {
				availableConcurrency: window.navigator.hardwareConcurrency,
				width: width,
				height: height,
				samplesPerPixel: 10
			}			
		})

		traceWorker.onerror = function(event) {
			console.log('There is an error in trace worker: ' + event);
		}
		traceWorker.onmessage = function(e) {
			if (e.data.type === "init") {
				document.getElementById("runButton").disabled = false;

			} else if (e.data.type === "image") {

				let spec = e.data.specification

				let imageArray = new Uint8ClampedArray(e.data.buffer)
				let imageData = new ImageData(imageArray, spec.drawWidth, spec.drawHeight);
				ctx.putImageData(imageData, spec.drawOffsetX, spec.drawOffsetY);

				let p = document.getElementById("progress");
				let percent = (e.data.progress * 100).toFixed(1)
				p.innerText = percent + "%"

				if (percent === "100.0") {
					let duration = ((performance.now() - startTime) / 1000).toFixed(2)
					p.innerText += ', took ' + duration + 's'
				}

			}
		}

		function run() {
			document.getElementById("runButton").disabled = true;
			traceWorker.postMessage({type: "start"})
			startTime = performance.now()	
		}
	</script>

</body>

</html>